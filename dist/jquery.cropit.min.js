/*
 *  cropit - v0.0.1
 *  Easy crop and zoom
 *  https://github.com/scottcheng/cropit
 *
 *  Made by Scott Cheng
 *  Based on https://github.com/yufeiliu/simple_image_uploader
 *  Under MIT License
 */
(function(){!function(a,b,c){var d,e,f,g;return g="cropit",f={exportZoom:1,imageBackground:!1,imageBackgroundBorderSize:0,imageState:null},d=function(){function d(b,c){var d;this.element=b,this.$el=a(this.element),d={$fileInput:this.$('input[name="image"]'),$preview:this.$(".image-preview"),$imageZoomInput:this.$(".image-zoom-level"),$previewContainer:this.$(".image-preview-container")},this.options=a.extend({},f,d,c),this._defaults=f,this._name=g,this.init()}return d.prototype.init=function(){var c,d,f,g,h,i,j,k;return this.$fileInput=this.options.$fileInput,this.$preview=this.options.$preview,this.$imageZoomInput=this.options.$imageZoomInput,this.$hiddenImage=a("<img />").addClass("image-hidden-preview").attr({alt:"",style:"display: none;"}).appendTo(this.$el),this.options.width&&this.$preview.width(this.options.width),this.options.height&&this.$preview.height(this.options.height),this.previewSize={w:this.options.width||this.$preview.width(),h:this.options.height||this.$preview.height()},this.options.imageBackground&&(f=this.options.imageBackgroundBorderSize,d=this.options.$previewContainer,this.$imageBg=a("<img />").addClass("image-background").attr("alt","").css("position","absolute"),c=a("<div />").addClass("image-background-container").css({position:"absolute",zIndex:0,top:-f,left:-f,width:this.previewSize.w+2*f,height:this.previewSize.h+2*f}).append(this.$imageBg),d.css("position","relative").prepend(c),this.$preview.css("position","relative"),this.imageBgPreviewOffset={x:f+b.parseInt(this.$preview.css("border-left-width")),y:f+b.parseInt(this.$preview.css("border-top-width"))}),this.initialZoomSliderPos=0,this.disabled=!0,this.imageSrc=(null!=(g=this.options.imageState)?g.src:void 0)||null,this.sliderPos=(null!=(h=this.options.imageState)?h.sliderPos:void 0)||this.initialZoomSliderPos,this.zoom=(null!=(i=this.options.imageState)?i.zoom:void 0)||null,this.offset=(null!=(j=this.options.imageState)?j.offset:void 0)||{x:0,y:0},this.moveContinue=!1,this.zoomer=new e,this.$preview.on("mousedown mouseup mouseleave",this.handlePreviewEvent.bind(this)),this.$fileInput.on("change",this.onFileChange.bind(this)),this.$imageZoomInput.on("change mousemove",this.updateImageZoom.bind(this)),(null!=(k=this.options.imageState)?k.src:void 0)?this.loadImage():void 0},d.prototype.onFileChange=function(){var a,b,c;return"function"==typeof(c=this.options).onFileChange&&c.onFileChange(),b=new FileReader,a=this.$fileInput.get(0).files[0],b.readAsDataURL(a),b.onload=function(a){return function(b){return a.imageSrc=b.target.result,a.sliderPos=a.initialZoomSliderPos,a.offset={x:0,y:0},a.loadImage()}}(this)},d.prototype.loadImage=function(){var a;return this.$hiddenImage.attr("src",this.imageSrc),this.$preview.css("background-image","url("+this.imageSrc+")"),"function"==typeof(a=this.options).onImageLoading&&a.onImageLoading(),this.$hiddenImage.load(function(a){return function(){var b;return a.options.imageBackground&&a.$imageBg.attr("src",a.imageSrc),a.imageSize={w:a.$hiddenImage.width(),h:a.$hiddenImage.height()},a.zoomer.setup(a.imageSize,a.previewSize,a.options.exportZoom,a.options),a.$imageZoomInput.val(a.sliderPos),a.zoom=a.zoomer.getZoom(a.sliderPos),a.updateImageZoom(),a.disabled=!1,"function"==typeof(b=a.options).onImageLoaded?b.onImageLoaded():void 0}}(this))},d.prototype.handlePreviewEvent=function(b){return this.disabled?void 0:(this.moveContinue=!1,this.$preview.off("mousemove"),"mousedown"===b.type?(this.origin={x:b.clientX,y:b.clientY},this.moveContinue=!0,this.$preview.on("mousemove",this.onMove.bind(this))):a(c.body).focus(),b.stopPropagation(),!1)},d.prototype.onMove=function(a){return this.moveContinue&&this.updateImageOffset({x:this.offset.x+a.clientX-this.origin.x,y:this.offset.y+a.clientY-this.origin.y}),this.origin={x:a.clientX,y:a.clientY},a.stopPropagation(),!1},d.prototype.updateImageOffset=function(a){return this.offset=this.fixOffset(a),this.$preview.css("background-position",""+a.x+"px "+a.y+"px"),this.options.imageBackground?this.$imageBg.css({left:this.offset.x+this.imageBgPreviewOffset.x,top:this.offset.y+this.imageBgPreviewOffset.y}):void 0},d.prototype.fixOffset=function(a){return this.imageSize.w*this.zoom<=this.previewSize.w?a.x=0:a.x>0?a.x=0:a.x+this.imageSize.w*this.zoom<this.previewSize.w&&(a.x=this.previewSize.w-this.imageSize.w*this.zoom),this.imageSize.h*this.zoom<=this.previewSize.h?a.y=0:a.y>0?a.y=0:a.y+this.imageSize.h*this.zoom<this.previewSize.h&&(a.y=this.previewSize.h-this.imageSize.h*this.zoom),a.x=Math.round(a.x),a.y=Math.round(a.y),a},d.prototype.updateImageZoom=function(){var a,b,c,d,e,f,g,h;if((null!=(g=this.imageSize)?g.w:void 0)&&(null!=(h=this.imageSize)?h.h:void 0))return this.sliderPos=Number(this.$imageZoomInput.val()),c=this.zoomer.getZoom(this.sliderPos),f=Math.round(this.imageSize.w*c),e=Math.round(this.imageSize.h*c),d=this.zoom,a=this.offset.x/d*c+this.previewSize.w/2-this.previewSize.w/2/d*c,b=this.offset.y/d*c+this.previewSize.h/2-this.previewSize.h/2/d*c,this.updateImageOffset({x:a,y:b}),this.$preview.css("background-size",""+f+"px "+e+"px"),this.options.imageBackground&&this.$imageBg.css({width:f,height:e}),this.zoom=c},d.prototype.isZoomable=function(){return this.zoomer.isZoomable()},d.prototype.getCroppedImage=function(){var b,c,d;return this.imageSrc?(d={w:this.previewSize.w,h:this.previewSize.h},this.options.fitHeight&&!this.options.fitWidth&&this.imageSize.w*this.zoom<this.previewSize.w?d.w=this.imageSize.w*this.zoom:this.options.fitWidth&&!this.options.fitHeight&&this.imageSize.h*this.zoom<this.previewSize.h&&(d.h=this.imageSize.h*this.zoom),b=a("<canvas />").attr({style:"display: none;",width:d.w*this.options.exportZoom,height:d.h*this.options.exportZoom}).appendTo(this.$el),c=b[0].getContext("2d"),c.drawImage(this.$hiddenImage[0],this.offset.x*this.options.exportZoom,this.offset.y*this.options.exportZoom,this.zoom*this.options.exportZoom*this.imageSize.w,this.zoom*this.options.exportZoom*this.imageSize.h),b[0].toDataURL()):null},d.prototype.getImageState=function(){return{src:this.imageSrc,offset:this.offset,zoom:this.zoom,sliderPos:this.sliderPos}},d.prototype.getImageSize=function(){return this.imageSize?{width:this.imageSize.w,height:this.imageSize.h}:null},d.prototype.$=function(a){return this.$el?this.$el.find(a):null},d}(),a.fn[g]=function(b){return this.each(function(){return a.data(this,"plugin_"+g)?void 0:a.data(this,"plugin_"+g,new d(this,b))})},e=function(){function a(){}return a.prototype.setup=function(a,b,c,d){var e,f;return f=b.w/a.w,e=b.h/a.h,this.minZoom=d.fitWidth&&!d.fitHeight?f:d.fitHeight&&!d.fitWidth?e:d.fitWidth&&d.fitHeight?e>f?f:e:e>f?e:f,this.maxZoom=this.minZoom<1/c?1/c:this.minZoom},a.prototype.getZoom=function(a){return this.minZoom&&this.maxZoom?a*(this.maxZoom-this.minZoom)+this.minZoom:null},a.prototype.isZoomable=function(){return this.minZoom&&this.maxZoom?this.minZoom!==this.maxZoom:null},a}()}(jQuery,window,document)}).call(this);